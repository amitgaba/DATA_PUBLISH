sap.ui.define([
	"sap/ui/core/mvc/Controller","sap/m/MessageToast"
], function(Controller,MessageToast) {
	"use strict";
     var lines = [];
     var json;
	return Controller.extend("dp.fileupload.ui.DataPublishFileUpload.controller.FileUpload", {
		/**
		*@memberOf pm.controller.Upload
		*/
		onUploadPress: function () {
			//This code was generated by the layout editor.
			var fileLoader = sap.ui.getCore().byId("__xmlview0--FileUploader");
			fileLoader.upload();
		},
		/**
		*@memberOf pm.controller.Upload
		*/
		handleTypeMissmatch: function(oEvent) {
			var aFileTypes = oEvent.getSource().getFileType();
			jQuery.each(aFileTypes, function(key, value) {aFileTypes[key] = "*." +  value;});
			var sSupportedFileTypes = aFileTypes.join(", ");
			MessageToast.show("The file type *." + oEvent.getParameter("fileType") +
									" is not supported. Choose one of the following types: " +
									sSupportedFileTypes);
		},
		
handleFiles: function(oEvent){
  //this._import(oEvent.getParameter("files")
  //             && oEvent.getParameter("files")[0]);
               
  var oFileToRead = oEvent.getParameter("files")[0];
  //oEvent.getParameters().files["0"];
  var reader = new FileReader();
	reader.readAsText(oFileToRead);
var that = this;
	reader.onload = function(evt) {
      // Read file into memory as UTF-8
      //reader.readAsText(oFileToRead);
	  var csv = evt.target.result;
      // Handle errors load
      //var csv = reader.result;
    
      //this.processData(csv);
      //this.processDataJSON(csv); 

        var allTextLines = csv.split(/\r\n|\n/);
		
		var result = [];

		var headers=allTextLines[0].split(",");

  for(var i=1;i<allTextLines.length;i++){

	  var obj = {};
	  var currentline=allTextLines[i].split(",");

	  for(var j=0;j<headers.length;j++){
		  obj[headers[j]] = currentline[j];
	  }

	  result.push(obj);

  }
  
  //return result; //JavaScript object
  json = JSON.stringify(result); //JSON
	
    };
      //reader.onload = loadHandler;
      //reader.onerror = errorHandler;
},
 
     loadHandler: function(event) {
      var csv = event.target.result;
      this.processData(csv);
    },

     processData: function(csv) {
        var allTextLines = csv.split(/\r\n|\n/);

        for (var i=0; i<allTextLines.length; i++) {
      var data = allTextLines[i].split(';');
      var tarr = [];
      for (var j=0; j<data.length; j++) {
           tarr.push(data[j]);
      }
lines.push(tarr);
        }
console.log(lines);
 
    },


     processDataJSON: function(csv) {
        var allTextLines = csv.split(/\r\n|\n/);
		
		var result = [];

		var headers=allTextLines[0].split(",");

  for(var i=1;i<allTextLines.length;i++){

	  var obj = {};
	  var currentline=allTextLines[i].split(",");

	  for(var j=0;j<headers.length;j++){
		  obj[headers[j]] = currentline[j];
	  }

	  result.push(obj);

  }
  
  //return result; //JavaScript object
  json = JSON.stringify(result); //JSON
	
    },
     errorHandler: function(evt) {
if(evt.target.error.name == "NotReadableError") {
alert("Cannot read file !");
      }
    },
	
		 onUploadComplete: function (oEvent) {
			var json_tmp = json;
			var oGlobalBusyDialog = new sap.m.BusyDialog();
			oGlobalBusyDialog.open();
			var url = "/DataPublishCSV.xsjs";

			var that = this;
				jQuery
					.ajax({
						type: "POST",
						data: json_tmp,
						dataType: "json",
						contentType: "application/json",
						url: url,
					success: function(reserv) {
						sap.m.MessageToast.show("Creation Successful");
					}
				});
		}

	});
});
